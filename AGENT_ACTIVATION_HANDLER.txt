
    // Handle agent activation via WhatsApp (Link LID to existing agent)
    async handleAgentActivation(phoneNumber, message, whatsappLid = null) {
        try {
            console.log(`ğŸ” Processing agent activation from ${phoneNumber}${whatsappLid ? ` (LID: ${whatsappLid})` : ''}: ${message}`);

            if (!whatsappLid) {
                return this.sendReply(phoneNumber,
                    `âŒ Tidak dapat mendeteksi WhatsApp ID Anda!\\n\\n` +
                    `ğŸ’¡ Silakan coba lagi atau hubungi admin.`);
            }

            // Parse activation message
            // Format: REG [nomor/nama] atau AKTIFASI [nomor/nama]
            const parts = message.trim().split(/\\s+/);
            if (parts.length < 2) {
                return this.sendReply(phoneNumber,
                    `âŒ Format tidak valid!\\n\\n` +
                    `ğŸ“ Format yang benar:\\n` +
                    `*REG [nomor/nama]*\\n` +
                    `*AKTIFASI [nomor/nama]*\\n\\n` +
                    `ğŸ’¡ Contoh:\\n` +
                    `â€¢ REG 628123456789\\n` +
                    `â€¢ REG Ahmad\\n` +
                    `â€¢ AKTIFASI 628123456789\\n` +
                    `â€¢ AKTIFASI Ahmad Setiawan`);
            }

            // Remove command from parts
            parts.shift();
            const searchTerm = parts.join(' ');

            if (!searchTerm || searchTerm.trim().length < 2) {
                return this.sendReply(phoneNumber,
                    `âŒ Nomor atau nama harus diisi!\\n\\n` +
                    `ğŸ’¡ Contoh: *REG Ahmad* atau *REG 628123456789*`);
            }

            // Normalize phone number if it's a phone number
            let normalizedSearch = searchTerm.replace(/^\\+/, '');
            if (!normalizedSearch.startsWith('62') && /^\\d+$/.test(normalizedSearch)) {
                normalizedSearch = '62' + normalizedSearch;
            }

            // Search agent by phone or name in users table
            const database = require('../config/database');
            
            // Try to find by phone first, then by name
            let agent = null;
            
            // Search by phone
            if (/^\\d+$/.test(normalizedSearch)) {
                const phoneSQL = `SELECT * FROM users WHERE phone = ? AND role = 'agent'`;
                agent = await new Promise((resolve, reject) => {
                    database.getDb().get(phoneSQL, [normalizedSearch], (err, row) => {
                        if (err) reject(err);
                        else resolve(row);
                    });
                });
            }
            
            // If not found by phone, search by name (partial match)
            if (!agent) {
                const nameSQL = `SELECT * FROM users WHERE LOWER(full_name) LIKE LOWER(?) AND role = 'agent'`;
                const agents = await new Promise((resolve, reject) => {
                    database.getDb().all(nameSQL, [`%${searchTerm}%`], (err, rows) => {
                        if (err) reject(err);
                        else resolve(rows);
                    });
                });
                
                if (agents && agents.length === 1) {
                    agent = agents[0];
                } else if (agents && agents.length > 1) {
                    // Multiple matches found
                    const agentList = agents.map(a => `â€¢ ${a.full_name} (${a.phone})`).join('\\n');
                    return this.sendReply(phoneNumber,
                        `âš ï¸ *Ditemukan ${agents.length} agent dengan nama serupa:*\\n\\n` +
                        `${agentList}\\n\\n` +
                        `ğŸ’¡ Silakan gunakan nomor telepon yang spesifik:\\n` +
                        `Contoh: *REG 628123456789*`);
                }
            }

            if (!agent) {
                return this.sendReply(phoneNumber,
                    `âŒ Agent dengan nomor/nama "${searchTerm}" tidak ditemukan!\\n\\n` +
                    `ğŸ’¡ Pastikan Anda sudah terdaftar oleh admin.\\n` +
                    `ğŸ“ Hubungi admin untuk registrasi.`);
            }

            // Check if agent already has whatsapp_lid
            if (agent.whatsapp_lid) {
                return this.sendReply(phoneNumber,
                    `âš ï¸ *Agent Sudah Teraktifasi!*\\n\\n` +
                    `ğŸ‘¤ Nama: ${agent.full_name}\\n` +
                    `ğŸ“± Nomor: ${agent.phone}\\n` +
                    `ğŸ’° Saldo: Rp ${(agent.balance || 0).toLocaleString('id-ID')}\\n\\n` +
                    `âœ… Akun Anda sudah aktif dan siap digunakan!\\n\\n` +
                    `ğŸ’¡ Ketik *help* untuk melihat menu.`);
            }

            // Check if whatsapp_lid column exists in users table
            const checkColumnSQL = `PRAGMA table_info(users)`;
            const columns = await new Promise((resolve, reject) => {
                database.getDb().all(checkColumnSQL, [], (err, rows) => {
                    if (err) reject(err);
                    else resolve(rows);
                });
            });
            
            const hasLidColumn = columns.some(col => col.name === 'whatsapp_lid');
            
            if (!hasLidColumn) {
                console.log('ğŸ“ Adding whatsapp_lid column to users table...');
                const alterSQL = `ALTER TABLE users ADD COLUMN whatsapp_lid TEXT`;
                await new Promise((resolve, reject) => {
                    database.getDb().run(alterSQL, [], (err) => {
                        if (err) reject(err);
                        else {
                            console.log('âœ… whatsapp_lid column added to users table');
                            resolve();
                        }
                    });
                });
            }

            // Update agent dengan whatsapp_lid
            const updateSQL = `UPDATE users SET whatsapp_lid = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ? AND role = 'agent'`;
            
            return new Promise((resolve, reject) => {
                database.getDb().run(updateSQL, [whatsappLid, agent.id], function(err) {
                    if (err) {
                        console.error('âŒ Error updating agent whatsapp_lid:', err);
                        return reject(err);
                    }

                    if (this.changes > 0) {
                        console.log(`âœ… Agent LID updated: ${agent.full_name} (${agent.phone}) -> LID: ${whatsappLid}`);
                        
                        // Send success message
                        const replyMessage =
                            `ğŸ‰ *AKTIVASI BERHASIL!*\\n\\n` +
                            `âœ… WhatsApp Anda telah terhubung dengan akun agent:\\n\\n` +
                            `ğŸ‘¤ Nama: ${agent.full_name}\\n` +
                            `ğŸ“± Nomor: ${agent.phone}\\n` +
                            `ğŸ’° Saldo: Rp ${(agent.balance || 0).toLocaleString('id-ID')}\\n` +
                            `ğŸ“Š Status: ${agent.is_active ? 'Aktif' : 'Tidak Aktif'}\\n\\n` +
                            `ğŸ¯ Akun Anda sekarang siap digunakan!\\n\\n` +
                            `ğŸ’¡ Ketik *help* untuk melihat menu dan cara penggunaan.`;
                        
                        resolve(this.sendReply(phoneNumber, replyMessage));
                    } else {
                        console.error('âŒ No rows updated for agent activation');
                        reject(new Error('No rows updated'));
                    }
                });
            });

        } catch (error) {
            console.error('âŒ Error handling agent activation:', error);
            return this.sendReply(phoneNumber,
                `âŒ Terjadi kesalahan saat memproses aktivasi!\\n\\n` +
                `ğŸ’¡ Silakan coba lagi atau hubungi admin.`);
        }
    }
